<% 
  autopilot = ENV.fetch('AUTOPILOT', 'px4')
  headless = ENV.fetch('HEADLESS', 'false') == 'true'
  camera = ENV.fetch('CAMERA', 'true') == 'true'
  lidar = ENV.fetch('LIDAR', 'true') == 'true'

  sim_subnet = ENV.fetch('SIM_SUBNET', '10.42')
  ground_id = ENV.fetch('GROUND_ID', '101')

  num_quads = ENV.fetch('NUM_QUADS', 1).to_i
  num_vtols = ENV.fetch('NUM_VTOLS', 0).to_i
  world = ENV.fetch('WORLD', 'impalpable_greyness')

  gnd_container = ENV.fetch('GND_CONTAINER', 'true') == 'true'

  simulated_time = ENV.fetch('SIMULATED_TIME', 'false') == 'true'
  rtf = ENV.fetch('RTF', '1.0').to_f
  start_as_paused = ENV.fetch('START_AS_PAUSED', 'false') == 'true'

  gymnasium = ENV.fetch('GYMNASIUM', 'false') == 'true'
  gym_freq_hz = ENV.fetch('GYM_FREQ_HZ', 50).to_i
  gym_init_duration = ENV.fetch('GYM_INIT_DURATION', '80.0').to_f

  drones = []
  num_quads.times { |i| drones << { type: 'quad', index: i } }
  num_vtols.times { |i| drones << { type: 'vtol', index: i } }

  if rtf <= 0.0
    speedup = 10 # 0.0 or negative RTF: limit to 10 speedup for PX4/ArduPilot SITL stability
  else
    speedup = rtf.ceil # Positive RTF: round up to the nearest integer
  end
  rtf_string = "<real_time_factor>%g</real_time_factor>" % speedup

  # Compute step size for gymnasium based on physics frequency in the world SDF files
  physics_freq_hz = (autopilot == 'px4') ? 250 : 500
  physics_dt = (autopilot == 'px4') ? 0.004 : 0.002
  gym_step_size = (physics_freq_hz / gym_freq_hz).to_i
  gym_step_size = 1 if gym_step_size < 1
%>

name: sim

windows:

  - gz_sim:
      layout: main-horizontal
      panes:
        - clear && echo "So nice to have you with us, this is the simulation container."
        - >
          <% unless camera %>
          sed -i '/<sensor/,/<\/sensor>/d' /aas/simulation_resources/aircraft_models/sensor_camera/model.sdf &&
          <% end %>
          <% unless lidar %>
          sed -i '/<sensor/,/<\/sensor>/d'  /aas/simulation_resources/aircraft_models/sensor_lidar/model.sdf &&
          <% end %>
          sed -i 's|<real_time_factor>1.0</real_time_factor>|<%= rtf_string %>|' /aas/simulation_resources/simulation_worlds/<%= world %>.sdf &&
          <% if autopilot == 'ardupilot' %>
          /aas/simulation_resources/aircraft_models/_create_ardupilot_models.sh <%= num_quads %> <%= num_vtols %>  &&
          /aas/simulation_resources/simulation_worlds/_create_ardupilot_world.sh <%= num_quads %> <%= num_vtols %> <%= world %>.sdf &&
          GZ_SIM_SYSTEM_PLUGIN_PATH=/aas/github_apps/ardupilot_gazebo/build:$GZ_SIM_SYSTEM_PLUGIN_PATH 
          <% end %>
          GZ_SIM_RESOURCE_PATH=$GZ_SIM_RESOURCE_PATH:/aas/simulation_resources/aircraft_models:/aas/simulation_resources/simulation_worlds 
          GZ_SIM_PHYSICS_ENGINE_PATH=$GZ_SIM_PHYSICS_ENGINE_PATH:/usr/lib/x86_64-linux-gnu/gz-physics-7/engine-plugins/
          gz sim -v2 <%= start_as_paused ? '' : '-r' %> <%= headless ? '-s' : '' %> <%= autopilot == 'px4' ? "#{world}.sdf" : "populated_ardupilot.sdf" %>
        - python3 /aas/simulation_resources/scripts/gz_wind.py --stop_wind

  <% drones.each_with_index do |drone, sitl_instance| %>
  <% 
    drone_id = sitl_instance + 1
    is_quad = drone[:type] == 'quad'
    if autopilot == 'px4'
      autostart = is_quad ? 5140 : 5141
      model_name = is_quad ? "x500_#{sitl_instance}" : "standard_vtol_#{sitl_instance}"
      x_offset = drone[:index] * 2
      y_offset = is_quad ? x_offset : x_offset + 2
      sensor_path = ''
    elsif autopilot == 'ardupilot'
      vehicle_config = is_quad ? '-v ArduCopter -f gazebo-iris' : '-v ArduPlane'
      model_name = is_quad ? "iris_with_ardupilot_#{drone_id}" : "alti_transition_quad_#{drone_id}"
      sensor_path = is_quad ? 'model/iris/' : ''
    end
  %>
  <% if autopilot == 'px4' %>
  - px4_sitl_<%= drone_id %>:
      layout: main-horizontal
      panes:
        - >
          sleep <%= sitl_instance * 1.5 %> &&
          PX4_GZ_MODEL_POSE=<%= "#{x_offset},#{y_offset},0.75,0,0,0" %>
          PX4_SYS_AUTOSTART=<%= autostart %> ROS_DOMAIN_ID=<%= drone_id %> <%= gnd_container ? "AAS_GROUND_IP=#{sim_subnet}.90.#{ground_id}" : "" %>
          PX4_UXRCE_DDS_NS="Drone<%= drone_id %>" PX4_UXRCE_DDS_AG_IP=<%= "#{sim_subnet}.90.#{drone_id}" %> PX4_UXRCE_DDS_PORT=8888
          /aas/github_apps/PX4-Autopilot/build/px4_sitl_default/bin/px4 -i <%= sitl_instance %>
  <% elsif autopilot == 'ardupilot' %>
  - ardu_sitl_<%= drone_id %>:
      layout: main-horizontal
      panes:
        - >
          sleep <%= sitl_instance * 3.0 %> && mkdir -p /aas/ardu_sitl_<%= drone_id %> && cd /aas/ardu_sitl_<%= drone_id %> &&
          /aas/github_apps/ardupilot/Tools/autotest/sim_vehicle.py 
          <%= vehicle_config %> --model JSON
          -I <%= sitl_instance %> --sysid <%= drone_id %>
          --speedup <%= speedup %>
          --add-param-file=/aas/simulation_resources/aircraft_models/<%= model_name %>/ardupilot-4.6.params
          -l $(python3 /aas/simulation_resources/patches/extract_spherical_coords.py /aas/simulation_resources/simulation_worlds/<%= world %>.sdf)
          --out=udp:<%= "#{sim_subnet}.90.#{drone_id}" %>:8888
          <% if gnd_container %>
          --out=udp:<%= "#{sim_subnet}.90.#{ground_id}" %>:<%= 14550 + sitl_instance %> --out=udp:<%= "#{sim_subnet}.90.#{ground_id}" %>:<%= 14540 + sitl_instance %>
          <% else %>
          --out=udp:127.0.0.1:<%= 14550 + sitl_instance %>
          <% end %>
  <% end %>
        <% if camera %>
        - >
          /aas/simulation_resources/comms/gz_gst_bridge/build/gz_gst_bridge
          /world/<%= world %>/model/<%= model_name %>/<%= sensor_path %>model/simple_camera/link/mono_cam/base_link/sensor/imager/image
          <%= "#{sim_subnet}.90.#{drone_id}" %> 5600 8
        <% end %>
        <% if lidar %>
        - >
          ROS_DOMAIN_ID=<%= drone_id %> ros2 run ros_gz_bridge parameter_bridge 
          /world/<%= world %>/model/<%= model_name %>/<%= sensor_path %>model/simple_lidar/link/lidar/base_link/sensor/lidar3d/scan/points@sensor_msgs/msg/PointCloud2[gz.msgs.PointCloudPacked 
          --ros-args -r /world/<%= world %>/model/<%= model_name %>/<%= sensor_path %>model/simple_lidar/link/lidar/base_link/sensor/lidar3d/scan/points:=/lidar_points
        <% end %>
        - "ROS_DOMAIN_ID=<%= drone_id %> ros2 run ros_gz_bridge parameter_bridge /clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock"
  <% end %>

  <% unless gnd_container %>
  - zenoh_and_qgc:
      layout: even-horizontal
      panes:
        - zenoh-bridge-ros2dds
        <% if headless %>
        - echo "Headless mode, not launching QGroundControl."
        <% else %>
        - >
          <% if num_quads > 0 %>
          sed -i 's/virtualJoystickAutoCenterThrottle=false/virtualJoystickAutoCenterThrottle=true/g' /home/qgcuser/.config/QGroundControl/QGroundControl.ini &&
          <% end %>
          gosu qgcuser /squashfs-root/AppRun &
          (
            PRIMARY_RES=$(xrandr | grep -oE '[0-9]+x[0-9]+' | head -1)
            SCREEN_W=$(echo $PRIMARY_RES | cut -d'x' -f1); SCREEN_H=$(echo $PRIMARY_RES | cut -d'x' -f2)
            SCREEN_SCALE=$((SCREEN_H * 100 / 1080)) # Full HD = 100%
            WIN_W=$(( 800 * SCREEN_SCALE / 100 )); WIN_H=$(( 480 * SCREEN_SCALE / 100 ))
            POS_X=$((SCREEN_W - WIN_W)); POS_Y=$((4096))
            for i in {1..15}; do
              TARGET_NAME="QGroundControl"
              CURRENT_DESK=$(wmctrl -d | grep '*' | awk '{print $1}')
              WID=$(wmctrl -l | awk -v d="$CURRENT_DESK" -v n="$TARGET_NAME" '$2 == d && $0 ~ n "$" {print $1}' | head -n 1)
              if [ -n "$WID" ]; then
                wmctrl -i -r "$WID" -e "0,$POS_X,$POS_Y,$WIN_W,$WIN_H" && break
              fi
              sleep 2
            done
          )
        <% end %>
  <% end %>

  - gz_resize_and_clock_bridge:
      layout: even-horizontal
      panes:
        <% unless headless %>
        - >
          (
            PRIMARY_RES=$(xrandr | grep -oE '[0-9]+x[0-9]+' | head -1)
            SCREEN_W=$(echo $PRIMARY_RES | cut -d'x' -f1); SCREEN_H=$(echo $PRIMARY_RES | cut -d'x' -f2)
            SCREEN_SCALE=$((SCREEN_H * 100 / 1080)) # Full HD = 100%
            WIN_W=$(( 800 * SCREEN_SCALE / 100 )); WIN_H=$(( 480 * SCREEN_SCALE / 100 ))
            POS_X=$((SCREEN_W - WIN_W)); POS_Y=$(( 0 ))
            for i in {1..15}; do
              TARGET_NAME="Gazebo Sim"
              CURRENT_DESK=$(wmctrl -d | grep '*' | awk '{print $1}')
              WID=$(wmctrl -l | awk -v d="$CURRENT_DESK" -v n="$TARGET_NAME" '$2 == d && $0 ~ n "$" {print $1}' | head -n 1)
              if [ -n "$WID" ]; then
                wmctrl -i -r "$WID" -e "0,$POS_X,$POS_Y,$WIN_W,$WIN_H" && break
              fi
              sleep 2
            done
          )
        <% end %>
        <% if gnd_container %>
        - "ROS_DOMAIN_ID=<%= ground_id %> ros2 run ros_gz_bridge parameter_bridge /clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock"
        <% else %>
        - ros2 run ros_gz_bridge parameter_bridge /clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock
        <% end %>

  <% if gymnasium %>
  - zmq_bridge:
      layout: even-horizontal
      panes:
        - ros2 run zmq_bridge_cpp zmq_bridge_node --ros-args -p init_duration:=<%= gym_init_duration %> -p step_size:=<%= gym_step_size %> -p physics_dt:=<%= physics_dt %>
  <% end %>
